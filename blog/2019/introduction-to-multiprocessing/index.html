<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Introduction to Python multiprocessing | Fabio Pierazzi</title> <meta name="author" content="Fabio Pierazzi"> <meta name="description" content="This post gives an introduction to the use of Python multiprocessing"> <meta name="keywords" content="fabio, pierazzi, systems, security"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://fabio.pierazzi.com/blog/2019/introduction-to-multiprocessing/"> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Fabio </span>Pierazzi</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/team/">team</a> </li> <li class="nav-item "> <a class="nav-link" href="/service/">service</a> </li> <li class="nav-item "> <a class="nav-link" href="/opportunities/">opportunities</a> </li> <li class="nav-item "> <a class="nav-link" href="/grants/">grants</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Introduction to Python multiprocessing</h1> <p class="post-meta">March 2, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/tutorial"> <i class="fas fa-hashtag fa-sm"></i> tutorial</a>   <a href="/blog/tag/python"> <i class="fas fa-hashtag fa-sm"></i> python</a>   <a href="/blog/tag/multiprocessing"> <i class="fas fa-hashtag fa-sm"></i> multiprocessing</a>     ·   <a href="/blog/category/tutorial"> <i class="fas fa-tag fa-sm"></i> tutorial</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In the past few years, I have been frequently asked how to easily parallelize in Python. It seems that people is often confused by the documentation online and are not sure which solution to go for. So, I decided to write a blog post about a minimum working example of <code class="language-plaintext highlighter-rouge">multiprocessing</code>, which should be pretty easy and straightforward to use for a lot of situations.</p> <h2 id="requirements">Requirements</h2> <p>We need to import a couple of libraries: <code class="language-plaintext highlighter-rouge">multiprocessing</code> and (optionally) <code class="language-plaintext highlighter-rouge">tqdm</code>. In <code class="language-plaintext highlighter-rouge">Python3</code> (stable at 3.7 at the time of writing), the <code class="language-plaintext highlighter-rouge">multiprocessing</code> library is natively included; this library allows you to define a function that you can spawn with different parameters on separate processes (it does not perform multithreading).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">multiprocessing</span>
</code></pre></div></div> <p>The second library I would recommend is <code class="language-plaintext highlighter-rouge">tqdm</code>, which is not required but it has made my coding life so much easier since I started using it. This library creates a smart progress bar when it is used to wrap an iterable object (e.g., a list in a for cycle). To install it, just run <code class="language-plaintext highlighter-rouge">pip3 install tqdm --upgrade</code>. We will see how to use <code class="language-plaintext highlighter-rouge">tqdm</code> in its very basic form, but I recommend you to have a look at its <a href="https://github.com/tqdm/tqdm" rel="external nofollow noopener" target="_blank">official documentation</a> for more advanced usage.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</code></pre></div></div> <h2 id="function-to-parallelize">Function to parallelize</h2> <p>First, let us define the function that you would like to parallelize. You often have to rethink the logic of your program, but if you have some independent cpu-intensive operations (e.g., training, parsing of long files, preprocessing), chances are there is a way to rethink your code to create a single, independent function that will run on a separate process.</p> <p>Let us define here a function, namely <code class="language-plaintext highlighter-rouge">function_to_parallelize</code>, that just takes two parameters as input and sums them. In this function you can actually do any sort of processing, as long as it is dependent solely on the input parameters. It is relevant to observe that you must use a <strong>single input parameter</strong> for this function. This is not a problem, as this single parameter can be a dictionary containing many parameters that you can unpack. For the purpose of this tutorial, I am using <code class="language-plaintext highlighter-rouge">param1</code> and <code class="language-plaintext highlighter-rouge">param2</code> as parameter names, but of course you can use any name and number of parameters (as long as you embed them within a single <code class="language-plaintext highlighter-rouge">params</code> dictionary).</p> <p>Of course, parameter names need to match the names in the list you pass to the <code class="language-plaintext highlighter-rouge">multiprocessing</code> library (as we will see in a bit).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">function_to_parallelize</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">param1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">param1</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">param2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">param2</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># I would recommend to use a dictionary
</span>    <span class="c1"># so you can create richer results
</span>    <span class="c1"># to return to the main process
</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Do your processing with param1 and param2.
</span>    <span class="c1"># Here, you can do any sort of processing, and
</span>    <span class="c1"># it will be executed independently on a separate process
</span>    <span class="c1"># on a separate (virtual) core of your CPU
</span>    <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">param1</span><span class="o">+</span><span class="n">param2</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <h2 id="parallelization">Parallelization</h2> <p>To perform the actual parallelization, we need to define the number of (virtual) cores that we want to use, and we need to define a-priori the list of parameter combinations that we are going to spawn in parallel.</p> <hr> <p>You can check how many (virtual) cores you have by using the command line tools <code class="language-plaintext highlighter-rouge">htop</code> or <code class="language-plaintext highlighter-rouge">glances</code>. I would recommend always leaving a couple of cores free, to avoid your machine to go into thrashing with the experts.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This chooses all cores except 2, unless there are only two or less cores.
</span><span class="n">NCPU</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nf">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nf">cpu_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
</code></pre></div></div> <p>Then, you need to define the parameters that each process will receive as input. You have to basically create a list of parameters. They can be in any number and quantity, and I usually prefer to define them as a <code class="language-plaintext highlighter-rouge">generator</code> of a <code class="language-plaintext highlighter-rouge">dict comprehension</code> for brevity.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a Python generator containing a set comprehension of parameters.
# You need to identify what you would like to parallelize on, and then build
# the parameters dictionary
</span><span class="n">X_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">532</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">23</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">({</span>
    <span class="sh">'</span><span class="s">param1</span><span class="sh">'</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">param2</span><span class="sh">'</span><span class="p">:</span> <span class="mi">15</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_values</span><span class="p">)</span>

</code></pre></div></div> <p><strong>Note</strong>: I recommend <em>not</em> to pass big structures as parameters (e.g., large matrices) because it can create a lot of inter-process communication that can cause severe delays or memory errors (e.g., use all the RAM in the machine). When possible, use <a href="https://docs.python.org/3/tutorial/classes.html#generators" rel="external nofollow noopener" target="_blank">Python generators</a> instead of Python lists (as shown above); in this way, the parameters list will not be pre-allocated all at once, but instead it will be allocated while iterating through the cycle.</p> <hr> <p>Now we are ready to start the actual multiprocessing. We create a <code class="language-plaintext highlighter-rouge">Pool</code> of processes that is managed by the <code class="language-plaintext highlighter-rouge">multiprocessing</code> library itself. Then, Python allows us to iterate through the Pool and get back the results. The function <code class="language-plaintext highlighter-rouge">p.imap</code> returns the results in order.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">NCPU</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>    

    <span class="c1"># If you use "generators" for the params list,  
</span>    <span class="c1"># tqdm will not know the total length of the array
</span>    <span class="c1"># (required for the progress bar),
</span>    <span class="c1"># so you have to specify it explicitly,
</span>    <span class="c1"># or derive it from your params.
</span>    <span class="n">MAX_COUNT</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">X_values</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">imap</span><span class="p">(</span><span class="n">function_to_parallelize</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span><span class="n">total</span><span class="o">=</span><span class="n">MAX_COUNT</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">])</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  0%|          | 0/9 [00:00&lt;?, ?it/s]
</code></pre></div></div> <h2 id="troubleshooting">Troubleshooting</h2> <ol> <li> <p><strong>Machine becomes slow and unresponsive after using multiprocessing</strong></p> <p>I have noticed that sometimes the <code class="language-plaintext highlighter-rouge">multiprocessing</code> library, for very large batches of experiments, leaves some operating system reources in usage—hence, the virtual machine in which you may be running your experiments could become slow and unresponsive after many days of experiments. It may be a problem of the infrastructure I am using to do the experiments, but I have seen this also happening to other colleagues that use other infrastructures. My best recommendation so far is to <strong>restart the VM</strong> if it becomes very slow after using the <code class="language-plaintext highlighter-rouge">multiprocessing</code> library. I know this is a kind of “Have you tried to turn it off and on?” solution, but it has worked so far. I will dig deeper into this, or if you have any insight please do not hesitate to leave a comment below.</p> </li> <li> <p><strong>Each iteration is too slow/Too much RAM is being used</strong></p> <p>Double check that you are using a Python <code class="language-plaintext highlighter-rouge">generator</code> (and not a <code class="language-plaintext highlighter-rouge">list</code>) for the list of parameters (the object named <code class="language-plaintext highlighter-rouge">params</code> in the above code). Also, if you are passing big data structures (e.g., huge feature matrices), remember that that RAM will be used for each process spawned. So, I recommend to do slicing (if possible) before passing big matrices as parameters if you do not need all the rows/columns for your processing.</p> </li> </ol> <h2 id="final-considerations">Final Considerations</h2> <p>I hope you have found this tutorial useful. Many people go for complex solutions for parallelizing Python code, but in most cases I found out that this easy solution is quite as effective. I have put the full code of this minimum working example on GitHub, <a href="https://github.com/fbpierazzi/mwe-python-multiprocessing" rel="external nofollow noopener" target="_blank">here</a>. If you have any suggestion to improve this tutorial or any parts that are not clear, just leave a comment!</p> <p>I would be happy to hear if you have other suggestions to perform multiprocessing in a more effective way.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/malware-datasets/">Malware Datasets with Timestamps</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/literature-review-systems-security/">How to Review Literature in Systems Security</a> </li> </div> </div> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2024 Fabio Pierazzi. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: October 07, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-3D290BNS4E"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-3D290BNS4E");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>